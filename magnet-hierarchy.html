<!--
Copyright (c) 2015 DudeTeam. All rights reserved.
Authored by Maxime Perrimond <max.perrimond@gmail.com>
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-a11y-keys-behavior/iron-a11y-keys-behavior.html">
<link rel="import" href="magnet-hierarchy-item.html">

<dom-module id="magnet-hierarchy">

    <style>

        :host {
            display: block;
            position: relative;

            width: auto;
            height: auto;

            @apply(--magnet-hierarchy)
        }

    </style>

    <template>
        <label>
            <input type="text" value="{{argument::input}}">
        </label>
        <content></content>
    </template>

    <script>
        MagnetHierarchy = Polymer({
            is: "magnet-hierarchy",

            properties: {
                onSelect: {
                    type: Object
                },

                selectItem: {
                    type: Object,
                    value: null
                },

                argument: {
                    type: String,
                    observer: "_search"
                },

                items: {
                    type: Array
                }
            },

            behaviors: [Polymer.IronA11yKeysBehavior],

            listeners: {
                "item-click": "_itemClick",
                "items-search": "_itemsSearch"
            },

            ready: function () {
                this.keyEventTarget = document.body;
                this.addOwnKeyBinding("up", "_moveUpSelection");
                this.addOwnKeyBinding("down", "_moveDownSelection");
                this.addOwnKeyBinding("right", "_expandSelection");
                this.addOwnKeyBinding("left", "_minimiseSelection");
            },

            select: function (item) {
                if (!(item instanceof MagnetHierarchyItem)) {
                    if (typeof item === "string") {
                        if (this.items.every(function (i) {
                            if (i.name === item) {
                                item = i;
                                return false;
                            }
                            return true;
                        })) {
                            item = null;
                        }
                    }
                }

                if (item !== null) {
                    if (item !== this.selectItem) {
                        if (this.selectItem !== null) {
                            this.selectItem.classList.remove("active");
                        }
                        this.selectItem = item;
                        this.selectItem.classList.add("active");
                    }
                }
            },

            /**
             * Load the hierarchy on items given.
             * Format:
             *  [
             *      {item: {
             *          name: "name",
             *          icon: "icon", (Optional)
             *          data: ...
             *      }},
             *      {group: {
             *          name: "name",
             *          icon: "icon", (Optional)
             *          data: ...,
             *          items: [
             *              {item: { ... }},
             *              {item: { ... }},
             *              {group: { ... }}
             *          ]
             *      }}
             *  ]
             *
             * @param items
             */
            loadItems: function (items) {
                this.items = items;
                this._clear();
                var elements = this._load(this.items);
                this._appendItems(this, elements);
                Polymer.dom.flush();
            },

            _load: function (items) {
                var elements = [];
                for (var i = 0; i < items.length; i++) {
                    var item = items[i].item;
                    var group = false;
                    if (item === undefined) {
                        item = items[i].group;
                        if (item === undefined) {
                            continue;
                        }
                        group = true;
                    }
                    var element = new MagnetHierarchyItem(item.name, item.data);
                    if (item.icon !== undefined) {element.icon = item.icon; }
                    if (group) {
                        element.group = true;
                        if (item.expand !== undefined) {element.expand = item.expand; }
                        this._appendItems(element, this._load(item.items));
                    }
                    elements.push(element);
                }
                return elements;
            },

            _appendItems: function (parent, items) {
                for (var i = 0; i < items.length; i++) {
                    parent.pushItem(items[i]);
                }
            },

            pushItem: function (item) {
                Polymer.dom(this).appendChild(item);
            },

            insertBeforeItem: function (item, before) {

            },

            removeItem: function (item) {

            },

            moveItem: function (item, before, after) {

            },

            _moveUpSelection: function () {
                var previous = Polymer.dom(this.selectItem).previousSibling;
                if (previous !== undefined) {
                    if (previous.group && previous.expand) {
                        var last = this._selectLast(previous);
                        if (last !== undefined) {
                            this.select(last);
                            return;
                        }
                    }
                    this.select(previous);
                    return;
                }

                var parent = Polymer.dom(this.selectItem).parentNode;
                if (parent instanceof MagnetHierarchyItem) {
                    this.select(parent);
                }
            },

            _selectLast: function (item) {
                var last;
                if (item.group && item.expand) {
                    last = Polymer.dom(item).lastChild;
                    var lol = this._selectLast(last);
                    if (lol !== undefined) {
                        last = lol;
                    }
                }
                return last;
            },

            _moveDownSelection: function () {
                if (this.selectItem.group && this.selectItem.expand) {
                    var first = Polymer.dom(this.selectItem).firstChild;
                    if (first !== undefined) {
                        this.select(first);
                        return;
                    }
                }

                var next = Polymer.dom(this.selectItem).nextSibling;
                if (next !== undefined) {
                    this.select(next);
                    return;
                }

                var parent = Polymer.dom(this.selectItem).parentNode;
                while (parent instanceof MagnetHierarchyItem) {
                    next = Polymer.dom(parent).nextSibling;
                    if (next !== undefined) {
                        this.select(next);
                        return;
                    }
                    parent = Polymer.dom(parent).parentNode;
                }
            },

            _expandSelection: function () {
                if (this.selectItem !== null && this.selectItem.group) {
                    this.selectItem.expand = true;
                }
            },

            _minimiseSelection: function () {
                if (this.selectItem !== null && this.selectItem.group) {
                    this.selectItem.expand = false;
                }
            },

            _itemClick: function (event) {
                this.select(event.target);
                if (this.onSelect !== undefined) {
                    this.onSelect(event.detail);
                }
            },

            _search: function () {
                this._clear();
                var elements;
                if (this.argument) {
                    elements = this._load(this._filter(this.argument));
                } else {
                    elements = this._load(this.items);
                }
                this._appendItems(this, elements);
                Polymer.dom.flush();
            },

            _filter: function (argument) {
                var result = JSON.parse(JSON.stringify(this.items));
                this._filterItems(argument, result);
                return result;
            },

            _filterItems: function (argument, items) {
                for (var i = 0; i < items.length; i++) {
                    var item;
                    if (items[i].group) {
                        items[i].group.expand = true;
                        item = items[i].group;
                        this._filterItems(argument, item.items);
                    } else {
                        item = items[i].item;
                    }

                    var find = item.name.search(argument);
                    if (find !== -1) {
                        item.name = [
                            item.name.slice(0, find),
                            "<span class=\"magnet-hierarchy-item\">",
                            item.name.slice(find, find + argument.length),
                            "</span>",
                            item.name.slice(find+argument.length)
                        ].join("");
                    }
                }
            },

            _clear: function () {
                while (Polymer.dom(this).childNodes.length > 0) {
                    Polymer.dom(this).removeChild(Polymer.dom(this).firstChild);
                }
            }
        });
    </script>

</dom-module>