<!--
Copyright (c) 2015 DudeTeam. All rights reserved.
Authored by Dorian Pinaud <dorian.pinaud@gmail.com>
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="stylesheet" type="text/css" href="../components-font-awesome/css/font-awesome.min.css">

<dom-module id="magnet-drag-and-drop">
  <style>
    :host(:hover) {
      transition: opacity 420ms ease-in-out;
    }

  </style>
  <template>
    <content></content>
  </template>
  <script>
    MagnetDragAndDrop = Polymer({
      is: "magnet-drag-and-drop",

      properties: {
          name: {
            type: String,
            value: "droppable",
            readOnly: true
          },

          x: {
            type: Number,
            value: undefined
          },

          y: {
            type: Number,
            value: undefined
          },

          opacity: {
            type: Number,
            value: undefined
          }
      },

      listeners: {
          "track": "_onTrack"
      },

      _checkDragNDropElement: function (element) {
          if (element.name === "droppable") {
              return element;
          }
          var parentElement = element.parentElement;
          if (parentElement !== null) {
              return this._checkDragNDropElement(parentElement);
          }
          return null;
      },

      _onTrack: function (event) {
        event.stopPropagation();
        switch (event.detail.state) {
          case "start":
              this._saveState();
          break;
          case "track":
              this.x += event.detail.ddx;
              this.y += event.detail.ddy;
              this.transform('translate(' + this.x + 'px, ' + this.y + 'px)');
              this.style.opacity = 0.5;
          break;
          case "end":
              this._recoverState();              
              var hover = event.detail.hover();
              hover = this._checkDragNDropElement(hover);
              if (hover === null || hover === this) {
                return;
              }
              var parentCurrent = this.parentElement;
              if (parentCurrent !== null) {
                  parentCurrent.removeChild(this);
              }
              console.log(Polymer.dom(this));
              hover.parentNode.insertBeforeItem(Polymer.dom(this), hover);
          break;
        }
      },

      _recoverState: function() {
          this.style.opacity = this.opacity;
          this.x = 0;
          this.y = 0;
          this.transform('translate(' + this.x + 'px, ' + this.y + 'px)');
      },

      _saveState: function() {
          this.x = 0;
          this.y = 0;
          this.opacity = this.style.opacity;
      }

    });
  </script>
</dom-module>
